<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- iOS App å°ˆç”¨æ¨™ç±¤ï¼Œç¢ºä¿åŠ å…¥ä¸»ç•«é¢å¾Œä¿‚å…¨è¢å¹• -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="M Tracker">
    
    <title>M Tracker | Period Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #fffbfc; 
            overscroll-behavior-y: none;
        }
        .day-cell { aspect-ratio: 1/1.1; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.3s ease-out forwards; }
        
        .selected-ring {
            box-shadow: 0 0 0 2px #fb7185;
        }

        .timeline-line {
            position: absolute;
            left: 19px;
            top: 20px;
            bottom: -20px;
            width: 2px;
            background-color: #f1f5f9;
        }
        .last-item .timeline-line {
            display: none;
        }

        /* AI å»ºè­°æ¡†æ¨£å¼ */
        .ai-suggestion {
            background: linear-gradient(135deg, #fff5f7 0%, #fff 100%);
            border: 1px solid #ffe4e8;
            position: relative;
            overflow: hidden;
        }
        .ai-suggestion::before {
            content: "âœ¨";
            position: absolute;
            right: -5px;
            top: -5px;
            font-size: 24px;
            opacity: 0.1;
        }
    </style>
</head>
<body class="pb-20">

    <div class="max-w-md mx-auto min-h-screen">
        <!-- Header -->
        <header class="p-6 pb-2 flex justify-between items-end">
            <div>
                <h1 class="text-2xl font-bold text-rose-600">M Tracker</h1>
            </div>
            <div class="flex bg-white p-1 rounded-2xl shadow-sm border border-rose-100">
                <button onclick="switchView('calendar')" id="tab-calendar" class="px-4 py-1.5 rounded-xl text-xs font-bold transition-all bg-rose-500 text-white shadow-sm">æ—¥æ›†</button>
                <button onclick="switchView('summary')" id="tab-summary" class="px-4 py-1.5 rounded-xl text-xs font-bold transition-all text-gray-400">æ‘˜è¦</button>
            </div>
        </header>

        <!-- View: Calendar (æ—¥æ›†è¦–åœ–) -->
        <main id="view-calendar" class="px-4 animate-fade">
            <div class="bg-white rounded-[2.5rem] shadow-sm border border-rose-100 overflow-hidden mt-4">
                <div class="flex items-center justify-between p-5 border-b border-rose-50">
                    <!-- ä¸Šå€‹æœˆæŒ‰éˆ• -->
                    <button onclick="changeMonth(-1)" class="p-2 text-rose-400 hover:bg-rose-50 rounded-full transition-all active:scale-90 flex items-center justify-center">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18L9 12L15 6"/></svg>
                    </button>
                    <h2 id="monthTitle" class="font-bold text-gray-700 tracking-tight text-lg">2023å¹´ 10æœˆ</h2>
                    <!-- ä¸‹å€‹æœˆæŒ‰éˆ• -->
                    <button onclick="changeMonth(1)" class="p-2 text-rose-400 hover:bg-rose-50 rounded-full transition-all active:scale-90 flex items-center justify-center">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18L15 12L9 6"/></svg>
                    </button>
                </div>
                <div class="grid grid-cols-7 bg-rose-50/20 text-center py-2 text-[10px] font-bold text-rose-300 uppercase">
                    <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 p-2 gap-1"></div>
            </div>

            <!-- åº•éƒ¨è¨˜éŒ„é¢æ¿ -->
            <div id="record-panel" class="mt-6 bg-white rounded-[2.5rem] shadow-sm border border-rose-100 p-6 animate-fade">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <h3 id="recordDateTitle" class="text-lg font-bold text-gray-800 tracking-tight">ä»Šæ—¥è¨˜éŒ„</h3>
                        <div id="saveIndicator" class="hidden flex items-center gap-1 text-[10px] text-green-500 font-bold bg-green-50 px-2 py-0.5 rounded-full uppercase tracking-widest animate-pulse">
                            Saved
                        </div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="flex gap-3">
                        <label id="label-period" class="flex-1 flex flex-col items-center gap-2 p-4 rounded-3xl border-2 transition-all cursor-pointer text-center">
                            <input type="checkbox" id="check-period" class="hidden" onchange="autoSave()">
                            <span class="text-xl">ğŸ”´</span>
                            <span class="text-[11px] font-bold uppercase tracking-widest">ç¶“æœŸ</span>
                        </label>
                        <label id="label-pill" class="flex-1 flex flex-col items-center gap-2 p-4 rounded-3xl border-2 transition-all cursor-pointer text-center">
                            <input type="checkbox" id="check-pill" class="hidden" onchange="autoSave()">
                            <span class="text-xl">ğŸ’Š</span>
                            <span class="text-[11px] font-bold uppercase tracking-widest">é¿å­•è—¥</span>
                        </label>
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">å‚™è¨» / ç—‡ç‹€</label>
                        <textarea id="text-symptoms" rows="2" oninput="autoSave()" class="w-full p-4 bg-rose-50/20 rounded-2xl border-none text-sm focus:ring-1 focus:ring-rose-200 outline-none transition-all placeholder-rose-200" placeholder="ä»Šæ—¥æ„Ÿè¦ºé»ï¼Ÿ"></textarea>
                    </div>
                    
                    <!-- AI å¥åº·å»ºè­°å€åŸŸ -->
                    <div class="pt-2">
                        <button onclick="fetchAiSuggestion()" id="ai-btn" class="w-full py-3 px-4 rounded-2xl bg-rose-50 text-rose-500 text-xs font-bold transition-all hover:bg-rose-100 flex items-center justify-center gap-2 border border-rose-100">
                            <span id="ai-btn-text">âœ¨ AI ç²å–å°è²¼å£«</span>
                            <div id="ai-loading" class="hidden w-3 h-3 border-2 border-rose-300 border-t-rose-600 rounded-full animate-spin"></div>
                        </button>
                        <div id="ai-suggestion-box" class="hidden mt-3 p-4 rounded-2xl ai-suggestion text-xs leading-relaxed text-rose-800 animate-fade"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- View: Summary (æ‘˜è¦è¦–åœ–) -->
        <main id="view-summary" class="hidden px-6 pt-4 animate-fade">
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-rose-100 text-center">
                    <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">å¹³å‡é€±æœŸ</p>
                    <div class="flex items-baseline justify-center gap-1">
                        <span id="stat-avg-cycle" class="text-2xl font-bold text-rose-500">--</span>
                        <span class="text-[10px] text-gray-400 uppercase">å¤©</span>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-rose-100 text-center">
                    <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">å¹³å‡ç¶“æœŸ</p>
                    <div class="flex items-baseline justify-center gap-1">
                        <span id="stat-avg-period" class="text-2xl font-bold text-rose-500">--</span>
                        <span class="text-[10px] text-gray-400 uppercase">å¤©</span>
                    </div>
                </div>
            </div>
            <div id="timelineJournal" class="space-y-0 pb-10"></div>
        </main>

        <!-- é‡è¨­æ•¸æ“š -->
        <div class="text-center mt-12 opacity-30 pb-10 px-10">
            <button onclick="resetData()" class="text-[10px] font-bold uppercase tracking-widest underline decoration-dotted">é‡è¨­æ•¸æ“š</button>
        </div>
    </div>

    <script>
        const apiKey = ""; // Gemini API key provided at runtime
        let db = JSON.parse(localStorage.getItem('girl_diary_v1') || '{}');
        let viewDate = new Date();
        let activeDateKey = new Date().toISOString().split('T')[0];
        let currentView = 'calendar';

        // Gemini API èª¿ç”¨é‚è¼¯ï¼Œå…·å‚™æŒ‡æ•¸é€€é¿é‡è©¦æ©Ÿåˆ¶
        async function callGemini(prompt, retries = 5, delay = 1000) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: "ä½ æ˜¯ä¸€å€‹å°ˆæ¥­ä¸”æº«é¦¨çš„å¥³æ€§å¥åº·åŠ©æ‰‹ã€‚è«‹æ ¹æ“šç”¨æˆ¶éŒ„å…¥çš„ç—‡ç‹€ï¼Œæä¾›ç°¡çŸ­ã€æœ‰åŒç†å¿ƒçš„å¥åº·å°è²¼å£«æˆ–èˆ’ç·©å»ºè­°ã€‚å›ç­”é™æ–¼ç¹é«”ä¸­æ–‡ï¼Œä¸”ä¸è¶…é60å­—ã€‚" }] }
                    })
                });

                if (!response.ok) {
                    if (retries > 0 && response.status === 429) {
                        await new Promise(r => setTimeout(r, delay));
                        return callGemini(prompt, retries - 1, delay * 2);
                    }
                    throw new Error('API Error');
                }

                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "æš«æ™‚ç„¡æ³•ç”Ÿæˆå»ºè­°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
            } catch (error) {
                if (retries > 0) {
                    await new Promise(r => setTimeout(r, delay));
                    return callGemini(prompt, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        async function fetchAiSuggestion() {
            const symptoms = document.getElementById('text-symptoms').value;
            const btnText = document.getElementById('ai-btn-text');
            const loading = document.getElementById('ai-loading');
            const box = document.getElementById('ai-suggestion-box');

            if (!symptoms.trim()) {
                box.innerText = "è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥ä»Šå¤©çš„ç—‡ç‹€æˆ–å‚™è¨»ï¼ŒAI æ‰èƒ½ç‚ºä½ æä¾›å»ºè­°å–”ï¼";
                box.classList.remove('hidden');
                return;
            }

            btnText.innerText = "åˆ†æä¸­...";
            loading.classList.remove('hidden');
            box.classList.add('hidden');

            try {
                const prompt = `ç”¨æˆ¶è¼¸å…¥çš„ç—‡ç‹€æ˜¯ï¼š'${symptoms}'ã€‚è«‹çµ¦äºˆæº«é¦¨çš„å¥åº·å»ºè­°ã€‚`;
                const suggestion = await callGemini(prompt);
                box.innerText = suggestion;
                box.classList.remove('hidden');
            } catch (error) {
                box.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡å¾Œå†è©¦ã€‚";
                box.classList.remove('hidden');
            } finally {
                btnText.innerText = "âœ¨ AI ç²å–å°è²¼å£«";
                loading.classList.add('hidden');
            }
        }

        function switchView(view) {
            currentView = view;
            const calendarView = document.getElementById('view-calendar');
            const summaryView = document.getElementById('view-summary');
            const tabCal = document.getElementById('tab-calendar');
            const tabSum = document.getElementById('tab-summary');

            if (view === 'calendar') {
                calendarView.classList.remove('hidden');
                summaryView.classList.add('hidden');
                tabCal.className = "px-4 py-1.5 rounded-xl text-xs font-bold transition-all bg-rose-500 text-white shadow-sm";
                tabSum.className = "px-4 py-1.5 rounded-xl text-xs font-bold transition-all text-gray-400";
                renderCalendar();
            } else {
                calendarView.classList.add('hidden');
                summaryView.classList.remove('hidden');
                tabSum.className = "px-4 py-1.5 rounded-xl text-xs font-bold transition-all bg-rose-500 text-white shadow-sm";
                tabCal.className = "px-4 py-1.5 rounded-xl text-xs font-bold transition-all text-gray-400";
                renderSummary();
            }
        }

        function changeMonth(step) {
            viewDate.setMonth(viewDate.getMonth() + step);
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthTitle = document.getElementById('monthTitle');
            grid.innerHTML = '';
            
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            monthTitle.innerText = `${year}å¹´ ${month + 1}æœˆ`;

            const firstDay = new Date(year, month, 1).getDay();
            const lastDay = new Date(year, month + 1, 0).getDate();
            const prevLastDay = new Date(year, month, 0).getDate();
            const todayStr = new Date().toISOString().split('T')[0];
            const analysis = analyzeData();

            for (let i = firstDay; i > 0; i--) {
                grid.innerHTML += `<div class="day-cell text-gray-200 flex items-center justify-center text-sm font-medium opacity-20">${prevLastDay - i + 1}</div>`;
            }

            for (let i = 1; i <= lastDay; i++) {
                const dKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const entry = db[dKey] || {};
                const isToday = dKey === todayStr;
                const isSelected = dKey === activeDateKey;
                
                let isPredicted = false;
                if (analysis.predictionDate) {
                    const pDate = new Date(analysis.predictionDate);
                    for(let j=0; j<analysis.avgDuration; j++) {
                        const checkDate = new Date(pDate);
                        checkDate.setDate(checkDate.getDate() + j);
                        if (checkDate.toISOString().split('T')[0] === dKey) isPredicted = true;
                    }
                }

                let indicators = '';
                if (entry.period) indicators += '<div class="w-1.5 h-1.5 rounded-full bg-[#ff85a2]"></div>';
                if (entry.pill) indicators += '<div class="w-1.5 h-1.5 rounded-full bg-[#60a5fa]"></div>';
                if (entry.symptoms && !entry.period && !entry.pill) indicators += '<div class="w-1.5 h-1.5 rounded-full bg-gray-300"></div>';

                grid.innerHTML += `
                    <div onclick="selectDate('${dKey}')" class="day-cell relative flex flex-col items-center justify-center cursor-pointer transition-all rounded-2xl ${isSelected ? 'bg-rose-100 shadow-inner ring-1 ring-rose-300' : 'hover:bg-rose-50'} ${isPredicted ? 'bg-rose-50 border border-dashed border-rose-200' : ''}">
                        <span class="text-sm font-bold ${isToday ? 'text-rose-500 underline underline-offset-4' : 'text-gray-700'}">${i}</span>
                        <div class="flex gap-0.5 mt-1.5 h-1.5">${indicators}</div>
                    </div>
                `;
            }
            updateRecordPanel();
        }

        function analyzeData() {
            const sortedDates = Object.keys(db).filter(k => db[k].period).sort();
            if (sortedDates.length === 0) return { avgCycle: '--', avgDuration: 0, periods: [] };
            const periods = [];
            let current = null;
            sortedDates.forEach((dStr, idx) => {
                const date = new Date(dStr);
                if (!current) {
                    current = { start: date, end: date, days: 1, dateKey: dStr };
                } else {
                    const prevDate = new Date(sortedDates[idx - 1]);
                    const diff = Math.round((date - prevDate) / (1000 * 3600 * 24));
                    if (diff === 1) {
                        current.end = date;
                        current.days++;
                    } else {
                        periods.push(current);
                        current = { start: date, end: date, days: 1, dateKey: dStr };
                    }
                }
            });
            if (current) periods.push(current);
            let totalCycle = 0;
            let cycleCount = 0;
            for (let i = 0; i < periods.length - 1; i++) {
                const diffStart = Math.round((periods[i+1].start - periods[i].start) / (1000 * 3600 * 24));
                periods[i].cycle = diffStart;
                totalCycle += diffStart;
                cycleCount++;
            }
            const avgPeriod = Math.round(periods.reduce((acc, p) => acc + p.days, 0) / periods.length);
            const avgCycle = cycleCount > 0 ? Math.round(totalCycle / cycleCount) : 28;
            let predictionDate = null;
            if (periods.length > 0) {
                const last = periods[periods.length - 1];
                predictionDate = new Date(last.start);
                predictionDate.setDate(predictionDate.getDate() + avgCycle);
            }
            return { avgCycle: cycleCount > 0 ? avgCycle : '--', avgDuration: avgPeriod, periods, predictionDate };
        }

        function selectDate(dateKey) {
            activeDateKey = dateKey;
            renderCalendar();
            document.getElementById('ai-suggestion-box').classList.add('hidden');
        }

        function updateRecordPanel() {
            const entry = db[activeDateKey] || { period: false, pill: false, symptoms: '' };
            const [y, m, d] = activeDateKey.split('-');
            document.getElementById('recordDateTitle').innerText = `${parseInt(m)}æœˆ${parseInt(d)}æ—¥ è¨˜éŒ„`;
            document.getElementById('check-period').checked = entry.period;
            document.getElementById('check-pill').checked = entry.pill;
            document.getElementById('text-symptoms').value = entry.symptoms || '';
            updateLabelStyles();
        }

        function autoSave() {
            if (!activeDateKey) return;
            const isPeriod = document.getElementById('check-period').checked;
            const isPill = document.getElementById('check-pill').checked;
            const symptoms = document.getElementById('text-symptoms').value;
            if (!isPeriod && !isPill && !symptoms.trim()) delete db[activeDateKey];
            else db[activeDateKey] = { period: isPeriod, pill: isPill, symptoms: symptoms };
            localStorage.setItem('girl_diary_v1', JSON.stringify(db));
            updateLabelStyles();
            document.getElementById('saveIndicator').classList.remove('hidden');
            setTimeout(() => document.getElementById('saveIndicator').classList.add('hidden'), 2000);
            renderCalendar();
            if (currentView === 'summary') renderSummary();
        }

        function updateLabelStyles() {
            const pLabel = document.getElementById('label-period');
            const pillLabel = document.getElementById('label-pill');
            const pChecked = document.getElementById('check-period').checked;
            const pillChecked = document.getElementById('check-pill').checked;
            pLabel.className = `flex-1 flex flex-col items-center gap-2 p-4 rounded-3xl border-2 transition-all cursor-pointer ${pChecked ? 'bg-rose-500 border-rose-500 text-white shadow-md' : 'bg-white border-rose-50 text-rose-500'}`;
            pillLabel.className = `flex-1 flex flex-col items-center gap-2 p-4 rounded-3xl border-2 transition-all cursor-pointer ${pillChecked ? 'bg-blue-500 border-blue-500 text-white shadow-md' : 'bg-white border-blue-50 text-blue-500'}`;
        }

        function renderSummary() {
            const analysis = analyzeData();
            document.getElementById('stat-avg-cycle').innerText = analysis.avgCycle;
            document.getElementById('stat-avg-period').innerText = analysis.avgDuration;
            const container = document.getElementById('timelineJournal');
            container.innerHTML = '';
            const list = [...analysis.periods].reverse();
            if (list.length === 0) {
                container.innerHTML = '<div class="text-center py-20 bg-white rounded-[2rem] border border-dashed border-rose-100 text-gray-300 text-sm italic tracking-tight">æš«æ™‚æœªæœ‰è¶³å¤ ç¶“æœŸè¨˜éŒ„</div>';
                return;
            }
            list.forEach((p, idx) => {
                const mLabel = p.start.toLocaleString('zh-HK', { month: 'short' });
                const dLabel = p.start.getDate();
                const yLabel = p.start.getFullYear();
                const isLast = idx === list.length - 1;
                container.innerHTML += `
                    <div class="relative flex gap-6 pb-6 ${isLast ? 'last-item' : ''}">
                        <!-- æ™‚é–“è»¸å°è»Œ -->
                        <div class="flex flex-col items-center flex-shrink-0 relative">
                            <div class="w-10 h-10 rounded-full border-4 border-rose-50 bg-rose-500 flex items-center justify-center text-white z-10 shadow-sm">
                                <span class="text-[10px] font-bold">${dLabel}</span>
                            </div>
                            <div class="timeline-line"></div>
                        </div>
                        <div class="flex-grow pt-1 pb-4">
                            <div class="flex justify-between items-baseline mb-2">
                                <h4 class="font-bold text-gray-800 text-lg">${mLabel}${dLabel}æ—¥</h4>
                                <span class="text-[10px] font-bold text-gray-300 uppercase">${yLabel}</span>
                            </div>
                            <div class="flex gap-2">
                                <span class="text-[10px] font-bold bg-rose-50 text-rose-500 px-2.5 py-1 rounded-full border border-rose-100 uppercase tracking-tight">ç¶“æœŸ ${p.days}å¤©</span>
                                ${p.cycle ? `<span class="text-[10px] font-bold bg-gray-50 text-gray-400 px-2.5 py-1 rounded-full border border-gray-100 uppercase tracking-tight">æœ¬æ¬¡é€±æœŸ ${p.cycle}å¤©</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function resetData() {
            if (confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) {
                db = {}; localStorage.removeItem('girl_diary_v1');
                renderCalendar(); if (currentView === 'summary') renderSummary();
            }
        }
        renderCalendar();
    </script>
</body>
</html>